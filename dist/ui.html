<!DOCTYPE html>
<html>
<head>
  <title>KD Prompt Generator</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body { 
      font-family: Inter, -apple-system, sans-serif; 
      font-size: 14px; 
      color: #1a1a1a; 
      background: #fff;
      line-height: 1.5;
    }
    
    /* Screens */
    .screen { display: none; height: 100vh; flex-direction: column; }
    .screen.active { display: flex; }
    
    /* Home Screen */
    .home-screen { padding: 32px 24px; }
    
    .steps-title {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 16px;
      color: #1a1a1a;
    }
    
    .steps-list {
      list-style: none;
      margin-bottom: 24px;
    }
    
    .steps-list li {
      margin-bottom: 12px;
      color: #666;
      padding-left: 24px;
      position: relative;
    }
    
    .steps-list li::before {
      content: attr(data-num) ".";
      position: absolute;
      left: 0;
      color: #666;
    }
    
    .steps-list li strong {
      color: #1a1a1a;
      font-weight: 600;
    }
    
    .bonus-text {
      color: #666;
      margin-bottom: 32px;
      font-size: 14px;
    }
    
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 14px 24px;
      border-radius: 12px;
      border: none;
      cursor: pointer;
      font-size: 16px;
      font-weight: 500;
      font-family: inherit;
      transition: all 0.2s;
      text-decoration: none;
    }
    
    .btn-primary {
      background: #5B4CFF;
      color: white;
      width: 100%;
    }
    
    .btn-primary:hover {
      background: #4A3CFF;
    }
    
    .btn-outline {
      background: transparent;
      color: #5B4CFF;
      border: 2px solid #5B4CFF;
      padding: 12px 24px;
    }
    
    .btn-outline:hover {
      background: #F0EBFF;
    }
    
    .home-buttons {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
    }
    
    .footer {
      margin-top: auto;
      text-align: center;
      padding: 24px;
    }
    
    .coffee-link {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      color: #666;
      text-decoration: underline;
      font-size: 14px;
      margin-bottom: 8px;
    }
    
    .coffee-link:hover {
      color: #1a1a1a;
    }
    
    .footer-text {
      font-size: 13px;
      color: #999;
    }
    
    /* Generator Screen */
    .generator-screen { padding: 16px; }
    
    .top-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }
    
    .back-btn {
      display: flex;
      align-items: center;
      gap: 4px;
      background: none;
      border: none;
      color: #1a1a1a;
      font-size: 14px;
      cursor: pointer;
      padding: 8px 0;
      font-family: inherit;
    }
    
    .back-btn:hover {
      color: #5B4CFF;
    }
    
    .search-box {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 16px;
      border: 1px solid #E5E5E5;
      border-radius: 12px;
      margin-bottom: 16px;
    }
    
    .search-box:focus-within {
      border-color: #5B4CFF;
    }
    
    .search-box svg {
      color: #999;
      flex-shrink: 0;
    }
    
    .search-input {
      border: none;
      outline: none;
      font-size: 14px;
      width: 100%;
      font-family: inherit;
    }
    
    .search-input::placeholder {
      color: #999;
    }
    
    .layer-list {
      flex: 1;
      overflow-y: auto;
      border: 1px solid #E5E5E5;
      border-radius: 16px;
      margin-bottom: 16px;
    }
    
    .layer-item {
      padding: 12px 16px;
      border-bottom: 1px solid #F5F5F5;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .layer-item:last-child {
      border-bottom: none;
    }
    
    .layer-item:hover {
      background: #FAFAFA;
    }
    
    .layer-item.selected {
      background: #F0EBFF;
    }
    
    .layer-type {
      font-size: 11px;
      color: #888;
      background: #F0F0F0;
      padding: 3px 8px;
      border-radius: 6px;
      font-weight: 500;
    }
    
    .layer-name {
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      font-size: 14px;
    }
    
    .annotation-input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #E5E5E5;
      border-radius: 8px;
      font-size: 13px;
      margin-top: 8px;
      font-family: inherit;
    }
    
    .annotation-input:focus {
      outline: none;
      border-color: #5B4CFF;
    }
    
    .empty-state {
      padding: 60px 24px;
      text-align: center;
      color: #999;
      font-size: 14px;
    }
    
    .bottom-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding-top: 8px;
    }
    
    .btn-generate {
      padding: 14px 28px;
      border-radius: 12px;
      width: auto;
    }
    
    .bottom-coffee {
      display: flex;
      align-items: center;
      gap: 6px;
      color: #666;
      text-decoration: underline;
      font-size: 13px;
    }
    
    .bottom-coffee:hover {
      color: #1a1a1a;
    }
    
    .top-bar-right {
      position: relative;
    }
    
    .icon-button {
      width: 32px;
      height: 32px;
      border-radius: 999px;
      border: none;
      background: transparent;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      padding: 0;
    }
    
    .icon-button:hover {
      background: #F5F5F5;
    }
    
    .hamburger-lines {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    
    .hamburger-line {
      width: 16px;
      height: 2px;
      border-radius: 999px;
      background: #1a1a1a;
    }
    
    .menu-panel {
      position: fixed;
      right: 16px;
      top: 16px;
      background: #FFFFFF;
      border: 1px solid #E5E5E5;
      border-radius: 16px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
      padding: 6px 0;
      min-width: 180px;
      display: none;
      z-index: 110;
    }
    
    .menu-panel.open {
      display: block;
    }
    
    .menu-item {
      width: 100%;
      padding: 8px 14px;
      background: transparent;
      border: none;
      text-align: left;
      font-size: 14px;
      color: #333;
      cursor: pointer;
      font-family: inherit;
      display: block;
      text-decoration: none;
    }
    
    .menu-item:hover {
      background: #FAFAFA;
      color: #5B4CFF;
    }
    
    .menu-item + .menu-item {
      border-top: 1px solid #F5F5F5;
    }
    
    /* Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.4);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 24px;
      z-index: 100;
    }
    
    .modal-overlay.active {
      display: flex;
    }
    
    .modal {
      background: white;
      border-radius: 16px;
      padding: 24px;
      width: 100%;
      max-width: 380px;
      max-height: 80vh;
      overflow-y: auto;
    }
    
    .modal-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 20px;
      text-align: center;
    }
    
    .form-group {
      margin-bottom: 16px;
    }
    
    .form-label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      color: #666;
      margin-bottom: 6px;
    }
    
    .select-input {
      width: 100%;
      padding: 12px 14px;
      border: 1px solid #E5E5E5;
      border-radius: 10px;
      font-size: 14px;
      background: white;
      font-family: inherit;
      cursor: pointer;
    }
    
    .select-input:focus {
      outline: none;
      border-color: #5B4CFF;
    }
    
    .text-input {
      width: 100%;
      padding: 12px 14px;
      border: 1px solid #E5E5E5;
      border-radius: 10px;
      font-size: 14px;
      font-family: inherit;
    }
    
    .text-input:focus {
      outline: none;
      border-color: #5B4CFF;
    }
    
    .hint {
      font-size: 12px;
      color: #999;
      margin-top: 6px;
    }
    
    .hint a {
      color: #3F00FF;
    }
    
    .modal-actions {
      display: flex;
      gap: 12px;
      margin-top: 24px;
    }
    
    .modal-actions .btn {
      flex: 1;
      padding: 10px 16px;
      font-size: 14px;
    }
    
    .btn-secondary {
      background: #F5F5F5;
      color: #666;
    }
    
    .btn-secondary:hover {
      background: #EBEBEB;
    }
    
    .btn-danger {
      background: none;
      border: none;
      color: #E53935;
      font-size: 13px;
      cursor: pointer;
      padding: 8px 0;
      font-family: inherit;
    }
    
    .btn-danger:hover {
      text-decoration: underline;
    }
    
    /* Prompt Output Modal */
    .prompt-output {
      padding: 16px;
      border: 1px solid #E5E5E5;
      border-radius: 12px;
      font-size: 13px;
      line-height: 1.6;
      background: #FAFAFA;
      white-space: pre-wrap;
      max-height: 300px;
      overflow-y: auto;
      margin-bottom: 16px;
      font-family: 'SF Mono', Monaco, monospace;
    }
    
    .checkbox-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
    }
    
    .checkbox-row input {
      width: 18px;
      height: 18px;
      accent-color: #5B4CFF;
    }
    
    .checkbox-row label {
      font-size: 14px;
      color: #666;
      cursor: pointer;
    }
    
    .loading {
      opacity: 0.6;
      pointer-events: none;
    }
    
    .error-text {
      color: #E53935;
      font-size: 12px;
      margin-top: 8px;
    }
    
    .ai-upgrade-bar {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 14px;
      background: #F0EBFF;
      border-radius: 10px;
      margin-bottom: 12px;
    }
    
    .ai-upgrade-bar span {
      flex: 1;
      font-size: 13px;
      color: #5B4CFF;
    }
    
    .ai-upgrade-bar .btn {
      padding: 8px 14px;
      font-size: 13px;
      width: auto;
    }
    
    .history-section {
      border-top: 1px solid #E5E5E5;
      padding-top: 12px;
      margin-top: 8px;
    }
    
    .history-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    
    .history-title {
      font-weight: 600;
      font-size: 13px;
      color: #666;
    }
    
    .history-item {
      padding: 10px 12px;
      background: #FAFAFA;
      border-radius: 8px;
      margin-bottom: 6px;
      cursor: pointer;
      font-size: 13px;
      color: #666;
    }
    
    .history-item:hover {
      background: #F0F0F0;
    }
    
    .ai-status-text {
      font-size: 13px;
      color: #5B4CFF;
      text-align: center;
      padding: 8px 0;
    }
    
    .textarea-input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #E5E5E5;
      border-radius: 10px;
      font-size: 14px;
      font-family: inherit;
      resize: vertical;
      min-height: 72px;
    }
    
    .textarea-input:focus {
      outline: none;
      border-color: #5B4CFF;
    }
    
    .required {
      color: #E53935;
      font-weight: 500;
      font-size: 12px;
    }
    
    .optional {
      color: #999;
      font-size: 12px;
      font-weight: 400;
    }
    
    .success-text {
      color: #1B8A3E;
      font-size: 12px;
      margin-top: 8px;
    }
    
    .about-text,
    .about-meta {
      font-size: 13px;
      color: #555;
    }
    
    .hidden { display: none !important; }
  </style>
</head>
<body>
  
  <!-- HOME SCREEN -->
  <div class="screen home-screen active" id="homeScreen">
    <div class="top-bar">
      <div></div>
      <div class="top-bar-right">
        <button class="icon-button" id="homeMenuButton" aria-label="Open menu">
          <div class="hamburger-lines">
            <span class="hamburger-line"></span>
            <span class="hamburger-line"></span>
            <span class="hamburger-line"></span>
          </div>
        </button>
      </div>
    </div>

    <div>
      <h1 class="steps-title">How to use</h1>
      <ol class="steps-list">
        <li data-num="1">Select a frame in Figma</li>
        <li data-num="2"><strong>Click Prompt Generator</strong></li>
        <li data-num="3">Add notes to any layer that needs explanation</li>
        <li data-num="4">Copy the output and paste it into ChatGPT or Claude to refine your prompt further</li>
      </ol>
      <p class="bonus-text">Have an API key? Connect it below to get refined prompts directly here.</p>
    </div>
    
    <div class="home-buttons">
      <button class="btn btn-primary" id="startBtn">Prompt Generator</button>
      <button class="btn btn-outline" id="setupApiHomeBtn">Setup API</button>
    </div>
    
    <div class="footer">
      <a href="https://buymeacoffee.com/karan667" target="_blank" class="coffee-link">
        â˜• Buy me a Coffee
      </a>
      <p class="footer-text">Keep me motivated ðŸ˜Š</p>
    </div>
  </div>
  
  <!-- GENERATOR SCREEN -->
  <div class="screen generator-screen" id="generatorScreen">
    <div class="top-bar">
      <button class="back-btn" id="backBtn">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M15 18l-6-6 6-6"/>
        </svg>
        Back
      </button>
      <div class="top-bar-right">
        <button class="icon-button" id="menuButton" aria-label="Open menu">
          <div class="hamburger-lines">
            <span class="hamburger-line"></span>
            <span class="hamburger-line"></span>
            <span class="hamburger-line"></span>
          </div>
        </button>
      </div>
    </div>
    
    <div class="search-box">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="11" cy="11" r="8"/>
        <path d="M21 21l-4.35-4.35"/>
      </svg>
      <input type="text" class="search-input" id="searchInput" placeholder="Search by Layer Names">
    </div>
    
    <div class="checkbox-row">
      <input type="checkbox" id="firstPrompt">
      <label for="firstPrompt">First prompt (include global styles)</label>
    </div>
    
    <div class="layer-list" id="layerList">
      <div class="empty-state">All layers here</div>
    </div>
    
    <div class="bottom-bar">
      <button class="btn btn-primary btn-generate" id="generateBtn">Create Prompt</button>
      <a href="https://buymeacoffee.com/karan667" target="_blank" class="bottom-coffee">
        â˜• Buy me a Coffee
      </a>
    </div>
    
    <div class="history-section hidden" id="historySection">
      <div class="history-header">
        <div class="history-title">Recent Prompts</div>
        <button class="btn-danger" id="clearHistoryBtn">Clear</button>
      </div>
      <div id="historyList"></div>
    </div>
  </div>
  
  <div class="menu-panel" id="menuPanel">
    <button class="menu-item" id="menuItemSetup">Setup API</button>
    <a class="menu-item" id="menuItemHelp" href="https://kdpg.karandhimaan.com" target="_blank" rel="noopener noreferrer">Help &amp; Learn</a>
    <button class="menu-item" id="menuItemFeedback">Send Feedback</button>
    <button class="menu-item" id="menuItemAbout">About</button>
  </div>

  <!-- API SETTINGS MODAL -->
  <div class="modal-overlay" id="apiModal">
    <div class="modal">
      <h2 class="modal-title">AI Settings</h2>
      
      <div class="form-group">
        <label class="form-label">Provider</label>
        <select id="providerSelect" class="select-input">
          <option value="google">Google Gemini (Free)</option>
          <option value="openai">OpenAI</option>
          <option value="anthropic">Anthropic Claude</option>
        </select>
      </div>
      
      <div class="form-group">
        <label class="form-label">API Key</label>
        <input type="password" id="apiKeyInput" class="text-input" placeholder="Paste your API key...">
        <p class="hint" id="apiHint">
          Get free key: <a href="https://aistudio.google.com/app/apikey" target="_blank">Google AI Studio</a>
        </p>
      </div>
      
      <div class="modal-actions">
        <button class="btn btn-secondary" id="cancelApiBtn">Cancel</button>
        <button class="btn btn-primary" id="saveApiBtn">Save</button>
      </div>
    </div>
  </div>
  
  <!-- PROMPT OUTPUT MODAL -->
  <div class="modal-overlay" id="promptModal">
    <div class="modal">
      <h2 class="modal-title">Generated Prompt</h2>
      <div class="prompt-output" id="promptOutput"></div>
      <div id="aiStatusText" class="ai-status-text hidden"></div>
      <div id="errorText" class="error-text hidden"></div>
      <div class="ai-upgrade-bar hidden" id="aiUpgradeBar">
        <span>AI enhanced prompt ready</span>
        <button class="btn btn-primary" id="viewAiBtn">View AI Prompt</button>
      </div>
      <div class="modal-actions">
        <button class="btn btn-secondary" id="closePromptBtn">Close</button>
        <button class="btn btn-primary" id="copyBtn">Copy to Clipboard</button>
      </div>
    </div>
  </div>

  <!-- FEEDBACK MODAL -->
  <div class="modal-overlay" id="feedbackModal">
    <div class="modal">
      <h2 class="modal-title">Send Feedback</h2>

      <div class="form-group">
        <label class="form-label">Overall Experience <span class="required">*</span></label>
        <div class="checkbox-row">
          <input type="radio" name="feedbackExperience" id="expAmazing" value="Amazing">
          <label for="expAmazing">Amazing</label>
        </div>
        <div class="checkbox-row">
          <input type="radio" name="feedbackExperience" id="expGood" value="Good">
          <label for="expGood">Good</label>
        </div>
        <div class="checkbox-row">
          <input type="radio" name="feedbackExperience" id="expOkay" value="Okay">
          <label for="expOkay">Okay</label>
        </div>
        <div class="checkbox-row">
          <input type="radio" name="feedbackExperience" id="expNeedsWork" value="Needs Work">
          <label for="expNeedsWork">Needs Work</label>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">What do you use this plugin for? <span class="optional">(optional)</span></label>
        <div class="checkbox-row">
          <input type="checkbox" name="feedbackUsage" id="useCursor" value="cursor">
          <label for="useCursor">Generating prompts for Cursor</label>
        </div>
        <div class="checkbox-row">
          <input type="checkbox" name="feedbackUsage" id="useV0" value="v0">
          <label for="useV0">Generating prompts for v0</label>
        </div>
        <div class="checkbox-row">
          <input type="checkbox" name="feedbackUsage" id="useClaudeChatgpt" value="claude_chatgpt">
          <label for="useClaudeChatgpt">Generating prompts for Claude/ChatGPT</label>
        </div>
        <div class="checkbox-row">
          <input type="checkbox" name="feedbackUsage" id="useFigmaMake" value="figma_make">
          <label for="useFigmaMake">Generating prompts for Figma Make</label>
        </div>
        <div class="checkbox-row">
          <input type="checkbox" name="feedbackUsage" id="useOther" value="other">
          <label for="useOther">Other</label>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">What's missing or could be better? <span class="optional">(optional)</span></label>
        <textarea id="feedbackComments" class="textarea-input" rows="3" placeholder="Tell us what features you'd like to see..."></textarea>
      </div>

      <div class="form-group">
        <label class="form-label">Would you recommend this to other designers? <span class="required">*</span></label>
        <div class="checkbox-row">
          <input type="radio" name="feedbackRecommend" id="recDefinitely" value="Definitely">
          <label for="recDefinitely">Definitely</label>
        </div>
        <div class="checkbox-row">
          <input type="radio" name="feedbackRecommend" id="recMaybe" value="Maybe">
          <label for="recMaybe">Maybe</label>
        </div>
        <div class="checkbox-row">
          <input type="radio" name="feedbackRecommend" id="recNotYet" value="Not yet">
          <label for="recNotYet">Not yet</label>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">Your email <span class="optional">(optional)</span></label>
        <input type="email" id="feedbackEmail" class="text-input" placeholder="For follow-up (optional)">
      </div>

      <div id="feedbackError" class="error-text hidden"></div>
      <div id="feedbackSuccess" class="success-text hidden"></div>

      <div class="modal-actions">
        <button class="btn btn-secondary" id="cancelFeedbackBtn">Cancel</button>
        <button class="btn btn-primary" id="submitFeedbackBtn">Send Feedback</button>
      </div>
    </div>
  </div>

  <!-- ABOUT MODAL -->
  <div class="modal-overlay" id="aboutModal">
    <div class="modal">
      <h2 class="modal-title">About</h2>
      <div class="form-group">
        <p class="about-text">
          KD Prompt Generator helps you turn Figma designs into high-quality prompts for tools like Cursor, v0, Claude, and more.
        </p>
      </div>
      <div class="form-group">
        <p class="about-meta">
          Version: v1.0.0<br>
          Created by: Karan Dhimaan<br>
          Credits: Built for fast, AI-ready handoff from Figma.
        </p>
      </div>
      <div class="modal-actions">
        <button class="btn btn-primary" id="closeAboutBtn">Close</button>
      </div>
    </div>
  </div>

  <script>
    // State
    var layerTree = null;
    var annotations = {};
    var selectedLayers = {};
    var promptHistory = [];
    var apiSettings = { provider: 'google', apiKey: '' };
    var responseCache = {};
    var pendingAiPrompt = null;
    var layerSearchQuery = '';
    // Supabase configuration â€“ replace these placeholders at build time
    var SUPABASE_URL = 'https://gdvzczwujkoxitpeuenx.supabase.co';
    var SUPABASE_ANON_KEY = 'sb_publishable_zrDukCZVlAHI2P-f8PVkxQ_XqHPVcpf';

    parent.postMessage({ pluginMessage: { type: 'storage-get', key: 'api-settings' } }, '*');
    parent.postMessage({ pluginMessage: { type: 'storage-get', key: 'prompt-history' } }, '*');

    // Elements
    var homeScreen = document.getElementById('homeScreen');
    var generatorScreen = document.getElementById('generatorScreen');
    var startBtn = document.getElementById('startBtn');
    var backBtn = document.getElementById('backBtn');
    var homeMenuButton = document.getElementById('homeMenuButton');
    var menuButton = document.getElementById('menuButton');
    var menuPanel = document.getElementById('menuPanel');
    var menuItemSetup = document.getElementById('menuItemSetup');
    var menuItemHelp = document.getElementById('menuItemHelp');
    var menuItemFeedback = document.getElementById('menuItemFeedback');
    var menuItemAbout = document.getElementById('menuItemAbout');
    var setupApiHomeBtn = document.getElementById('setupApiHomeBtn');
    var searchInput = document.getElementById('searchInput');
    var layerListEl = document.getElementById('layerList');
    var generateBtn = document.getElementById('generateBtn');
    var firstPromptCheckbox = document.getElementById('firstPrompt');
    var clearHistoryBtn = document.getElementById('clearHistoryBtn');

    // Modals
    var apiModal = document.getElementById('apiModal');
    var promptModal = document.getElementById('promptModal');
    var feedbackModal = document.getElementById('feedbackModal');
    var aboutModal = document.getElementById('aboutModal');
    var providerSelect = document.getElementById('providerSelect');
    var apiKeyInput = document.getElementById('apiKeyInput');
    var apiHint = document.getElementById('apiHint');
    var saveApiBtn = document.getElementById('saveApiBtn');
    var cancelApiBtn = document.getElementById('cancelApiBtn');
    var promptOutput = document.getElementById('promptOutput');
    var copyBtn = document.getElementById('copyBtn');
    var closePromptBtn = document.getElementById('closePromptBtn');
    var errorText = document.getElementById('errorText');
    var aiUpgradeBar = document.getElementById('aiUpgradeBar');
    var viewAiBtn = document.getElementById('viewAiBtn');
    var aiStatusText = document.getElementById('aiStatusText');
    var feedbackError = document.getElementById('feedbackError');
    var feedbackSuccess = document.getElementById('feedbackSuccess');
    var cancelFeedbackBtn = document.getElementById('cancelFeedbackBtn');
    var submitFeedbackBtn = document.getElementById('submitFeedbackBtn');
    var closeAboutBtn = document.getElementById('closeAboutBtn');

    // Navigation
    startBtn.onclick = function() {
      showScreen('generator');
      parent.postMessage({ pluginMessage: { type: 'scan-selection' } }, '*');
    };

    backBtn.onclick = function() {
      showScreen('home');
    };

    function showScreen(screen) {
      homeScreen.classList.remove('active');
      generatorScreen.classList.remove('active');
      if (screen === 'home') {
        homeScreen.classList.add('active');
      } else {
        generatorScreen.classList.add('active');
      }
    }

    // API Modal
    setupApiHomeBtn.onclick = function() { openApiModal(); };

    function openApiModal() {
      providerSelect.value = apiSettings.provider;
      apiKeyInput.value = apiSettings.apiKey || '';
      updateApiHint();
      apiModal.classList.add('active');
    }

    providerSelect.onchange = updateApiHint;

    function updateApiHint() {
      var hints = {
        google: 'Get free key: <a href="https://aistudio.google.com/app/apikey" target="_blank">Google AI Studio</a>',
        openai: 'Get key: <a href="https://platform.openai.com/api-keys" target="_blank">OpenAI Platform</a>',
        anthropic: 'Get key: <a href="https://console.anthropic.com/" target="_blank">Anthropic Console</a>'
      };
      apiHint.innerHTML = hints[providerSelect.value];
    }

    saveApiBtn.onclick = function() {
      apiSettings = {
        provider: providerSelect.value,
        apiKey: apiKeyInput.value.trim()
      };
      parent.postMessage({ pluginMessage: { type: 'storage-set', key: 'api-settings', value: apiSettings } }, '*');
      apiModal.classList.remove('active');
      parent.postMessage({ pluginMessage: { type: 'notify', message: 'API settings saved!' } }, '*');
    };

    cancelApiBtn.onclick = function() {
      apiModal.classList.remove('active');
    };

    // Hamburger menu
    function closeMenu() {
      if (menuPanel) {
        menuPanel.classList.remove('open');
      }
    }

    function attachMenuTrigger(button) {
      if (!button || !menuPanel) return;
      button.onclick = function(e) {
        e.stopPropagation();
        menuPanel.classList.toggle('open');
      };
    }

    attachMenuTrigger(menuButton);
    attachMenuTrigger(homeMenuButton);

    if (menuItemSetup) {
      menuItemSetup.onclick = function() {
        closeMenu();
        openApiModal();
      };
    }

    if (menuItemHelp) {
      menuItemHelp.onclick = function() {
        closeMenu();
      };
    }

    if (menuItemFeedback) {
      menuItemFeedback.onclick = function() {
        closeMenu();
        openFeedbackModal();
      };
    }

    if (menuItemAbout) {
      menuItemAbout.onclick = function() {
        closeMenu();
        openAboutModal();
      };
    }

    document.addEventListener('click', function(e) {
      if (!menuPanel) return;
      if (menuPanel.contains(e.target)) return;
      if (menuButton && menuButton.contains(e.target)) return;
      if (homeMenuButton && homeMenuButton.contains(e.target)) return;
      closeMenu();
    });

    // Search
    searchInput.oninput = function() {
      layerSearchQuery = searchInput.value.toLowerCase();
      renderLayers();
    };

    // Clear history
    clearHistoryBtn.onclick = function() {
      promptHistory = [];
      parent.postMessage({ pluginMessage: { type: 'storage-set', key: 'prompt-history', value: [] } }, '*');
      renderHistory();
    };

    // Generate
    generateBtn.onclick = function() {
      if (!layerTree) {
        parent.postMessage({ pluginMessage: { type: 'notify', message: 'Please select a frame first' } }, '*');
        return;
      }
      doGenerate();
    };

    function doGenerate() {
      var basicPrompt = generateBasicPrompt();
      errorText.classList.add('hidden');
      aiUpgradeBar.classList.add('hidden');
      aiStatusText.classList.add('hidden');
      pendingAiPrompt = null;

      if (apiSettings.apiKey) {
        var cacheKey = simpleHash(basicPrompt);
        if (responseCache[cacheKey]) {
          showPrompt(responseCache[cacheKey]);
          saveToHistory(layerTree.name, responseCache[cacheKey]);
          return;
        }

        showPrompt(basicPrompt);
        saveToHistory(layerTree.name, basicPrompt);

        aiStatusText.textContent = 'Enhancing with AI...';
        aiStatusText.classList.remove('hidden');

        enhanceWithAI(basicPrompt).then(function(enhanced) {
          responseCache[cacheKey] = enhanced;
          pendingAiPrompt = enhanced;
          aiStatusText.classList.add('hidden');
          aiUpgradeBar.classList.remove('hidden');
        }).catch(function(err) {
          aiStatusText.classList.add('hidden');
          errorText.textContent = 'AI failed: ' + (err.message || 'Unknown error');
          errorText.classList.remove('hidden');
        });
      } else {
        showPrompt(basicPrompt);
        saveToHistory(layerTree.name, basicPrompt);
      }
    }

    function simpleHash(str) {
      var hash = 0;
      for (var i = 0; i < str.length; i++) {
        hash = ((hash << 5) - hash) + str.charCodeAt(i);
        hash |= 0;
      }
      return apiSettings.provider + ':' + hash.toString();
    }

    function showPrompt(text) {
      promptOutput.textContent = text;
      promptModal.classList.add('active');
    }

    // View AI enhanced prompt
    viewAiBtn.onclick = function() {
      if (pendingAiPrompt) {
        promptOutput.textContent = pendingAiPrompt;
        aiUpgradeBar.classList.add('hidden');
        saveToHistory(layerTree.name, pendingAiPrompt);
      }
    };

    // Prompt Modal
    closePromptBtn.onclick = function() {
      promptModal.classList.remove('active');
    };

    copyBtn.onclick = function() {
      var text = promptOutput.textContent;
      var textarea = document.createElement('textarea');
      textarea.value = text;
      textarea.style.position = 'fixed';
      textarea.style.opacity = '0';
      document.body.appendChild(textarea);
      textarea.select();
      try {
        document.execCommand('copy');
        parent.postMessage({ pluginMessage: { type: 'notify', message: 'Copied to clipboard!' } }, '*');
      } catch(e) {
        parent.postMessage({ pluginMessage: { type: 'notify', message: 'Copy failed' } }, '*');
      }
      document.body.removeChild(textarea);
    };

    // Feedback modal
    function resetFeedbackForm() {
      var inputs = feedbackModal.querySelectorAll('input[type="radio"], input[type="checkbox"]');
      for (var i = 0; i < inputs.length; i++) {
        inputs[i].checked = false;
      }
      var commentsEl = document.getElementById('feedbackComments');
      var emailEl = document.getElementById('feedbackEmail');
      if (commentsEl) commentsEl.value = '';
      if (emailEl) emailEl.value = '';
    }

    function openFeedbackModal() {
      feedbackError.classList.add('hidden');
      feedbackSuccess.classList.add('hidden');
      feedbackModal.classList.add('active');
    }

    function closeFeedbackModal() {
      feedbackModal.classList.remove('active');
      resetFeedbackForm();
    }

    cancelFeedbackBtn.onclick = function() {
      closeFeedbackModal();
    };

    feedbackModal.onclick = function(e) {
      if (e.target === feedbackModal) {
        closeFeedbackModal();
      }
    };

    submitFeedbackBtn.onclick = function() {
      feedbackError.classList.add('hidden');
      feedbackSuccess.classList.add('hidden');
    
      var experience = document.querySelector('input[name="feedbackExperience"]:checked');
      var recommend = document.querySelector('input[name="feedbackRecommend"]:checked');
    
      if (!experience || !recommend) {
        feedbackError.textContent = 'Please answer the required questions.';
        feedbackError.classList.remove('hidden');
        return;
      }
    
      var usageNodes = document.querySelectorAll('input[name="feedbackUsage"]:checked');
      var usage = [];
      for (var i = 0; i < usageNodes.length; i++) {
        usage.push(usageNodes[i].value);
      }
    
      var comments = (document.getElementById('feedbackComments').value || '').trim();
      var email = (document.getElementById('feedbackEmail').value || '').trim();
    
      var payload = {
        experience: experience.value,
        recommend: recommend.value,
        usage: usage.join(', '),
        comments: comments || null,
        email: email || null
      };

      // If Supabase credentials are not configured (public GitHub build),
      // show a friendly message instead of attempting a failing network call.
      var hasRealSupabaseConfig =
        SUPABASE_URL.indexOf('YOUR_SUPABASE_PROJECT_ID') === -1 &&
        SUPABASE_ANON_KEY.indexOf('YOUR_SUPABASE_ANON_KEY') === -1;

      if (!hasRealSupabaseConfig) {
        feedbackError.textContent = 'Feedback sending is disabled in this public build.';
        feedbackError.classList.remove('hidden');
        return;
      }
    
      submitFeedbackBtn.disabled = true;
    
      fetch(SUPABASE_URL + '/rest/v1/feedback', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'apikey': SUPABASE_ANON_KEY,
          'Authorization': 'Bearer ' + SUPABASE_ANON_KEY,
          'Prefer': 'return=minimal'
        },
        body: JSON.stringify(payload)
      }).then(function(res) {
        if (!res.ok) {
          return res.text().then(function(text) {
            throw new Error(text || ('Supabase error ' + res.status));
          });
        }
      }).then(function() {
        feedbackSuccess.textContent = 'Thanks for your feedback!';
        feedbackSuccess.classList.remove('hidden');
        parent.postMessage({ pluginMessage: { type: 'notify', message: 'Thanks for your feedback!' } }, '*');
        setTimeout(function() {
          closeFeedbackModal();
        }, 1200);
      }).catch(function(err) {
        feedbackError.textContent = 'Could not send feedback: ' + (err.message || 'Please try again later.');
        feedbackError.classList.remove('hidden');
        console.error(err);
      }).finally(function() {
        submitFeedbackBtn.disabled = false;
      });
    };

    // About modal
    function openAboutModal() {
      aboutModal.classList.add('active');
    }

    function closeAboutModal() {
      aboutModal.classList.remove('active');
    }

    closeAboutBtn.onclick = function() {
      closeAboutModal();
    };

    aboutModal.onclick = function(e) {
      if (e.target === aboutModal) {
        closeAboutModal();
      }
    };

    apiModal.onclick = function(e) {
      if (e.target === apiModal) {
        apiModal.classList.remove('active');
      }
    };

    promptModal.onclick = function(e) {
      if (e.target === promptModal) {
        promptModal.classList.remove('active');
      }
    };

    // Listen for messages from Figma
    window.onmessage = function(event) {
      var msg = event.data.pluginMessage;
      if (!msg) return;

      if (msg.type === 'layer-tree') {
        layerTree = msg.data;
        annotations = {};
        selectedLayers = {};
        layerSearchQuery = '';
        searchInput.value = '';
        renderLayers();
      }

      if (msg.type === 'error') {
        parent.postMessage({ pluginMessage: { type: 'notify', message: msg.message } }, '*');
      }

      if (msg.type === 'storage-result') {
        if (msg.key === 'api-settings' && msg.value) {
          apiSettings = msg.value;
        }
        if (msg.key === 'prompt-history' && msg.value) {
          promptHistory = msg.value;
          renderHistory();
        }
      }
    };

    // --- Fetch with exponential backoff ---
    function fetchWithRetry(url, options, maxRetries) {
      maxRetries = maxRetries || 3;
      var attempt = 0;

      function doFetch() {
        return fetch(url, options).then(function(res) {
          if (res.status === 429 && attempt < maxRetries) {
            attempt++;
            var retryAfter = res.headers.get('Retry-After');
            var waitMs = retryAfter
              ? parseInt(retryAfter) * 1000
              : Math.min(1000 * Math.pow(2, attempt), 16000);
            aiStatusText.textContent = 'AI rate limited â€” retrying (' + attempt + '/' + maxRetries + ')...';
            aiStatusText.classList.remove('hidden');
            return new Promise(function(resolve) {
              setTimeout(resolve, waitMs);
            }).then(doFetch);
          }
          return res;
        });
      }

      return doFetch();
    }

    // --- AI Enhancement ---
    function enhanceWithAI(basicPrompt) {
      var systemPrompt = 'You are a UI/UX expert. Take this design spec and create a clear, actionable prompt for AI coding tools (Cursor, v0, Lovable, Figma Make, Codex). Be concise. Focus on: component hierarchy, layout (flexbox/grid), key styles, interactions. Output only the improved prompt.';

      if (apiSettings.provider === 'google') {
        return fetchWithRetry('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=' + apiSettings.apiKey, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{ parts: [{ text: systemPrompt + '\n\nDesign spec:\n' + basicPrompt }] }]
          })
        }, 3)
        .then(handleResponse)
        .then(function(data) {
          if (data.candidates && data.candidates[0] && data.candidates[0].content) {
            return data.candidates[0].content.parts[0].text;
          }
          throw new Error('Invalid response from Google Gemini');
        });
      }

      if (apiSettings.provider === 'openai') {
        return fetchWithRetry('https://api.openai.com/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + apiSettings.apiKey
          },
          body: JSON.stringify({
            model: 'gpt-4o-mini',
            messages: [
              { role: 'system', content: systemPrompt },
              { role: 'user', content: basicPrompt }
            ]
          })
        }, 3)
        .then(handleResponse)
        .then(function(data) {
          if (data.choices && data.choices[0]) {
            return data.choices[0].message.content;
          }
          throw new Error('Invalid response from OpenAI');
        });
      }

      if (apiSettings.provider === 'anthropic') {
        return fetchWithRetry('https://api.anthropic.com/v1/messages', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-api-key': apiSettings.apiKey,
            'anthropic-version': '2023-06-01',
            'anthropic-dangerous-direct-browser-access': 'true'
          },
          body: JSON.stringify({
            model: 'claude-3-haiku-20240307',
            max_tokens: 2048,
            system: systemPrompt,
            messages: [{ role: 'user', content: basicPrompt }]
          })
        }, 3)
        .then(handleResponse)
        .then(function(data) {
          if (data.content && data.content[0]) {
            return data.content[0].text;
          }
          throw new Error('Invalid response from Anthropic');
        });
      }

      return Promise.reject(new Error('Unknown provider'));
    }

    function handleResponse(res) {
      if (res.status === 429) {
        throw new Error('Rate limit reached (429). Free tier allows ~15 requests/min. All retries exhausted.');
      }
      if (!res.ok) {
        return res.json().then(function(err) {
          throw new Error(err.error?.message || 'API error ' + res.status);
        }).catch(function(parseErr) {
          if (parseErr.message && parseErr.message.indexOf('API error') !== -1) throw parseErr;
          throw new Error('API error ' + res.status + ' (non-JSON response)');
        });
      }
      return res.json();
    }

    // --- Layer rendering with search ---
    function layerMatchesSearch(layer, query) {
      if (!query) return true;
      if (layer.name.toLowerCase().indexOf(query) !== -1) return true;
      if (layer.type.toLowerCase().indexOf(query) !== -1) return true;
      if (layer.children) {
        for (var i = 0; i < layer.children.length; i++) {
          if (layerMatchesSearch(layer.children[i], query)) return true;
        }
      }
      return false;
    }

    function renderLayers() {
      if (!layerTree) {
        layerListEl.innerHTML = '<div class="empty-state">Select a frame and click "Prompt Generator"</div>';
        return;
      }
      layerListEl.innerHTML = '';
      var rendered = renderLayerItem(layerTree, layerListEl, layerSearchQuery);
      if (layerSearchQuery && !rendered) {
        layerListEl.innerHTML = '<div class="empty-state">No layers match "' + searchInput.value + '"</div>';
      }
    }

    function renderLayerItem(layer, container, query) {
      var selfMatches = !query ||
        layer.name.toLowerCase().indexOf(query) !== -1 ||
        layer.type.toLowerCase().indexOf(query) !== -1;
      var childHasMatch = false;

      if (layer.children) {
        for (var i = 0; i < layer.children.length; i++) {
          if (layerMatchesSearch(layer.children[i], query)) {
            childHasMatch = true;
            break;
          }
        }
      }

      if (query && !selfMatches && !childHasMatch) return false;

      var div = document.createElement('div');

      var item = document.createElement('div');
      item.className = 'layer-item' + (selectedLayers[layer.id] ? ' selected' : '');
      item.style.paddingLeft = (layer.depth * 12 + 16) + 'px';

      var typeSpan = document.createElement('span');
      typeSpan.className = 'layer-type';
      typeSpan.textContent = layer.type;

      var nameSpan = document.createElement('span');
      nameSpan.className = 'layer-name';
      nameSpan.textContent = layer.name;

      item.appendChild(typeSpan);
      item.appendChild(nameSpan);

      item.onclick = function() {
        selectedLayers[layer.id] = !selectedLayers[layer.id];
        renderLayers();
      };

      div.appendChild(item);

      if (selectedLayers[layer.id]) {
        var inputDiv = document.createElement('div');
        inputDiv.style.padding = '0 16px 12px ' + (layer.depth * 12 + 16) + 'px';

        var input = document.createElement('input');
        input.type = 'text';
        input.className = 'annotation-input';
        input.placeholder = 'Add note for this element...';
        input.value = annotations[layer.id] || '';
        input.onclick = function(e) { e.stopPropagation(); };
        input.oninput = function(e) {
          annotations[layer.id] = e.target.value;
        };

        inputDiv.appendChild(input);
        div.appendChild(inputDiv);
      }

      container.appendChild(div);

      if (layer.children) {
        for (var i = 0; i < layer.children.length; i++) {
          renderLayerItem(layer.children[i], container, query);
        }
      }

      return true;
    }

    function flattenLayers(layer, result) {
      result = result || [];
      result.push(layer);
      if (layer.children) {
        for (var i = 0; i < layer.children.length; i++) {
          flattenLayers(layer.children[i], result);
        }
      }
      return result;
    }

    // --- Prompt generation ---
    function generateBasicPrompt() {
      var layers = flattenLayers(layerTree);
      var prompt = '';

      prompt += 'Build this UI component:\n\n';

      if (firstPromptCheckbox.checked) {
        prompt += '## Project Setup\n';
        prompt += 'Create these CSS variables first:\n';
        prompt += '```css\n:root {\n';
        var tokens = extractDesignTokens(layers);
        if (tokens.colors.length > 0) {
          prompt += '  /* Colors */\n';
          for (var i = 0; i < tokens.colors.length; i++) {
            prompt += '  --color-' + (i + 1) + ': ' + tokens.colors[i] + ';\n';
          }
        }
        if (tokens.fontSizes.length > 0) {
          prompt += '  /* Typography */\n';
          for (var i = 0; i < tokens.fontSizes.length; i++) {
            var size = tokens.fontSizes[i];
            var name = getFontSizeName(parseInt(size));
            prompt += '  --font-' + name + ': ' + size + ';\n';
          }
        }
        prompt += '}\n```\n\n';
      }

      prompt += '## Component: ' + layerTree.name + '\n';
      prompt += 'Size: ' + layerTree.width + 'x' + layerTree.height + 'px (mobile)\n\n';

      prompt += '## Structure\n';
      prompt += '```\n';
      prompt += buildTreeView(layerTree, 0);
      prompt += '```\n\n';

      prompt += '## Key Elements\n\n';
      var keyElements = identifyKeyElements(layers);
      for (var i = 0; i < keyElements.length; i++) {
        var el = keyElements[i];
        prompt += '**' + el.name + '** (' + el.componentType + ')\n';
        if (el.size) prompt += '- Size: ' + el.size + '\n';
        if (el.text) prompt += '- Text: "' + el.text + '"\n';
        if (el.color) prompt += '- Color: ' + el.color + '\n';
        if (el.layout) prompt += '- Layout: ' + el.layout + '\n';
        if (annotations[el.id]) prompt += '- Note: ' + annotations[el.id] + '\n';
        prompt += '\n';
      }

      var annotationsList = [];
      for (var id in annotations) {
        if (annotations[id] && annotations[id].trim()) {
          var layer = findLayerById(layers, id);
          if (layer) annotationsList.push({ name: layer.name, note: annotations[id] });
        }
      }

      if (annotationsList.length > 0) {
        prompt += '## Custom Instructions\n';
        for (var i = 0; i < annotationsList.length; i++) {
          prompt += '- ' + annotationsList[i].name + ': ' + annotationsList[i].note + '\n';
        }
        prompt += '\n';
      }

      prompt += '## Requirements\n';
      prompt += '- Responsive (this is ' + layerTree.width + 'px mobile)\n';
      prompt += '- Use flexbox/grid\n';
      prompt += '- Semantic HTML\n';
      prompt += '- Accessible\n';

      return prompt;
    }

    function buildTreeView(layer, depth) {
      var indent = '';
      for (var i = 0; i < depth; i++) indent += '  ';

      var line = indent + getComponentIcon(layer) + ' ' + layer.name;

      var info = [];
      var compType = detectComponentType(layer);
      if (compType && compType !== 'Container') info.push(compType);
      if (layer.characters) info.push('"' + truncate(layer.characters, 20) + '"');

      if (info.length > 0) line += ' [' + info.join(', ') + ']';
      line += '\n';

      if (layer.children && depth < 3) {
        for (var i = 0; i < layer.children.length; i++) {
          line += buildTreeView(layer.children[i], depth + 1);
        }
      } else if (layer.children && layer.children.length > 0) {
        line += indent + '  ... (' + layer.children.length + ' children)\n';
      }

      return line;
    }

    function getComponentIcon(layer) {
      var type = detectComponentType(layer);
      if (type === 'Button') return '[btn]';
      if (type === 'Input Field') return '[input]';
      if (type === 'Text') return '[txt]';
      if (type === 'Image') return '[img]';
      if (type === 'Icon') return '[ico]';
      if (type === 'Avatar') return '[avatar]';
      if (type === 'Card') return '[card]';
      if (type === 'Navigation Bar') return '[nav]';
      if (type === 'Tab') return '[tab]';
      if (type === 'Badge') return '[badge]';
      if (type === 'Skeleton/Loading') return '[skeleton]';
      if (layer.type === 'FRAME' || layer.type === 'GROUP') return '[box]';
      if (layer.type === 'INSTANCE') return '[comp]';
      return '[' + layer.type.toLowerCase().substring(0, 3) + ']';
    }

    function identifyKeyElements(layers) {
      var key = [];
      for (var i = 0; i < layers.length; i++) {
        var layer = layers[i];
        var compType = detectComponentType(layer);
        var isKey = compType && compType !== 'Container' && compType !== 'Text';
        var hasNote = annotations[layer.id] && annotations[layer.id].trim();
        var isTopLevel = layer.depth <= 2;
        if ((isKey && isTopLevel) || hasNote) {
          var el = {
            id: layer.id,
            name: layer.name,
            componentType: compType || layer.type,
            size: layer.width + 'x' + layer.height + 'px'
          };
          if (layer.characters) el.text = truncate(layer.characters, 50);
          if (layer.fills && layer.fills[0] && layer.fills[0].color) {
            el.color = layer.fills[0].color;
          }
          if (layer.children && layer.children.length > 1) {
            el.layout = detectLayout(layer.children);
          }
          key.push(el);
        }
      }
      return key.slice(0, 15);
    }

    function findLayerById(layers, id) {
      for (var i = 0; i < layers.length; i++) {
        if (layers[i].id === id) return layers[i];
      }
      return null;
    }

    function truncate(str, len) {
      if (str.length <= len) return str;
      return str.substring(0, len) + '...';
    }

    function getFontSizeName(size) {
      if (size <= 10) return 'xs';
      if (size <= 12) return 'sm';
      if (size <= 14) return 'base';
      if (size <= 16) return 'md';
      if (size <= 18) return 'lg';
      if (size <= 22) return 'xl';
      if (size <= 26) return '2xl';
      return '3xl';
    }

    function detectComponentType(layer) {
      var name = layer.name.toLowerCase();
      var type = layer.type;
      if (name.includes('button') || name.includes('btn') || name.includes('cta')) return 'Button';
      if (name.includes('input') || name.includes('textfield')) return 'Input Field';
      if (name.includes('search')) return 'Search Bar';
      if (name.includes('statusbar') || name.includes('status bar')) return 'Status Bar';
      if (name.includes('nav') || name.includes('header') || name.includes('topbar')) return 'Navigation Bar';
      if (name.includes('tabbar') || name.includes('tab bar')) return 'Tab Bar';
      if (name.includes('tab')) return 'Tab';
      if (name.includes('card')) return 'Card';
      if (name.includes('avatar')) return 'Avatar';
      if (name.includes('icon')) return 'Icon';
      if (name.includes('image') || name.includes('img') || name.includes('photo')) return 'Image';
      if (name.includes('list')) return 'List';
      if (name.includes('modal') || name.includes('dialog') || name.includes('popup')) return 'Modal';
      if (name.includes('footer')) return 'Footer';
      if (name.includes('sidebar')) return 'Sidebar';
      if (name.includes('badge') || name.includes('tag') || name.includes('chip')) return 'Badge';
      if (name.includes('toggle') || name.includes('switch')) return 'Toggle';
      if (name.includes('checkbox')) return 'Checkbox';
      if (name.includes('radio')) return 'Radio';
      if (name.includes('dropdown') || name.includes('select')) return 'Dropdown';
      if (name.includes('progress')) return 'Progress Bar';
      if (name.includes('loading') || name.includes('skeleton')) return 'Skeleton/Loading';
      if (name.includes('divider') || name.includes('separator')) return 'Divider';
      if (name.includes('homeindicator')) return 'Home Indicator';
      if (type === 'TEXT') return 'Text';
      if (type === 'VECTOR' || type === 'BOOLEAN_OPERATION') return 'Icon';
      if (type === 'ELLIPSE') return 'Circle';
      if (type === 'FRAME' || type === 'GROUP' || type === 'INSTANCE') {
        if (layer.children && layer.children.length > 0) {
          var hasText = false;
          for (var i = 0; i < layer.children.length; i++) {
            if (layer.children[i].type === 'TEXT') hasText = true;
          }
          if (hasText && layer.width < 200 && layer.height < 60) return 'Button';
        }
        return 'Container';
      }
      return null;
    }

    function detectLayout(children) {
      if (!children || children.length < 2) return 'single';
      var first = children[0];
      var second = children[1];
      var hDiff = Math.abs((second.x || 0) - (first.x || 0));
      var vDiff = Math.abs((second.y || 0) - (first.y || 0));
      if (hDiff > vDiff * 2) return 'flex-row';
      if (vDiff > hDiff * 2) return 'flex-col';
      return 'grid';
    }

    function extractDesignTokens(layers) {
      var colors = [], fontSizes = [], colorSet = {}, fontSet = {};
      for (var i = 0; i < layers.length; i++) {
        var layer = layers[i];
        if (layer.fills) {
          for (var j = 0; j < layer.fills.length; j++) {
            var c = layer.fills[j].color;
            if (c && !colorSet[c]) { colorSet[c] = true; colors.push(c); }
          }
        }
        if (layer.fontSize && !fontSet[layer.fontSize]) {
          fontSet[layer.fontSize] = true;
          fontSizes.push(layer.fontSize + 'px');
        }
      }
      fontSizes.sort(function(a, b) { return parseInt(a) - parseInt(b); });
      return { colors: colors.slice(0, 8), fontSizes: fontSizes };
    }

    // --- History ---
    function saveToHistory(name, prompt) {
      var item = {
        id: Date.now().toString(),
        timestamp: new Date().toISOString(),
        frameName: name,
        prompt: prompt
      };
      promptHistory.unshift(item);
      if (promptHistory.length > 20) promptHistory = promptHistory.slice(0, 20);
      parent.postMessage({ pluginMessage: { type: 'storage-set', key: 'prompt-history', value: promptHistory } }, '*');
      renderHistory();
    }

    function renderHistory() {
      var section = document.getElementById('historySection');
      var list = document.getElementById('historyList');
      if (promptHistory.length === 0) {
        section.classList.add('hidden');
        return;
      }
      section.classList.remove('hidden');
      list.innerHTML = '';
      var shown = promptHistory.slice(0, 5);
      for (var i = 0; i < shown.length; i++) {
        var item = shown[i];
        var div = document.createElement('div');
        div.className = 'history-item';
        div.textContent = item.frameName + ' - ' + new Date(item.timestamp).toLocaleTimeString();
        div.onclick = (function(prompt) {
          return function() {
            showPrompt(prompt);
          };
        })(item.prompt);
        list.appendChild(div);
      }
    }
  </script>
</body>
</html>
